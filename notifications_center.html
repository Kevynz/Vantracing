<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VanTracing - Notificações em Tempo Real</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .notification-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        .notification-item.priority-low { border-left-color: #28a745; }
        .notification-item.priority-medium { border-left-color: #ffc107; }
        .notification-item.priority-high { border-left-color: #fd7e14; }
        .notification-item.priority-critical { border-left-color: #dc3545; }
        .notification-item.unread { background-color: #f8f9fa; font-weight: 500; }
        .notification-item:hover { background-color: #e9ecef; }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .notification-center {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .type-location_update .notification-icon { background-color: #e3f2fd; color: #1976d2; }
        .type-route_alert .notification-icon { background-color: #fff3e0; color: #f57c00; }
        .type-security_alert .notification-icon { background-color: #ffebee; color: #d32f2f; }
        .type-emergency .notification-icon { background-color: #ffebee; color: #d32f2f; }
        .type-system_message .notification-icon { background-color: #f3e5f5; color: #7b1fa2; }
        .type-child_pickup .notification-icon { background-color: #e8f5e8; color: #388e3c; }
        .type-arrival_notification .notification-icon { background-color: #e0f2f1; color: #00796b; }
        
        .notification-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1055;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Connection Status / Status da Conexão -->
    <div class="connection-status">
        <div id="connectionBadge" class="badge bg-secondary">
            <i class="fas fa-circle me-1"></i>
            Conectando...
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Header -->
            <div class="col-12 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Central de Notificações
                    </h1>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="markAllRead()">
                            <i class="fas fa-check-double me-1"></i>
                            Marcar Todas como Lidas
                        </button>
                        <button class="btn btn-outline-secondary" onclick="sendTestNotification()">
                            <i class="fas fa-vial me-1"></i>
                            Teste
                        </button>
                        <button class="btn btn-outline-info" onclick="refreshNotifications()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Atualizar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="col-12 mb-4">
                <div class="notification-stats" id="notificationStats">
                    <!-- Statistics cards will be loaded here -->
                </div>
            </div>

            <!-- Notifications List -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Notificações Recentes
                            <span class="badge bg-primary ms-2" id="unreadCount">0</span>
                        </h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="unreadOnlyFilter">
                            <label class="form-check-label" for="unreadOnlyFilter">
                                Apenas não lidas
                            </label>
                        </div>
                    </div>
                    <div class="card-body notification-center" id="notificationsList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Carregando notificações...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container for Real-time Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        class VanTracingNotificationCenter {
            constructor() {
                this.eventSource = null;
                this.notifications = [];
                this.unreadCount = 0;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                this.init();
            }
            
            init() {
                this.setupEventSource();
                this.loadNotifications();
                this.loadStats();
                this.setupEventListeners();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    if (!this.isConnected) {
                        this.loadNotifications();
                    }
                }, 30000);
            }
            
            setupEventSource() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
                
                this.eventSource = new EventSource('/api/notifications_sse.php');
                
                this.eventSource.onopen = () => {
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus('connected');
                    console.log('SSE connection established');
                };
                
                this.eventSource.onmessage = (event) => {
                    console.log('SSE message received:', event.data);
                };
                
                this.eventSource.addEventListener('connected', (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Connected to notifications:', data);
                });
                
                this.eventSource.addEventListener('notification', (event) => {
                    const notification = JSON.parse(event.data);
                    this.handleNewNotification(notification);
                });
                
                this.eventSource.addEventListener('system_notification', (event) => {
                    const notification = JSON.parse(event.data);
                    this.handleSystemNotification(notification);
                });
                
                this.eventSource.addEventListener('heartbeat', (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Heartbeat:', data.server_time);
                });
                
                this.eventSource.onerror = (error) => {
                    this.isConnected = false;
                    this.updateConnectionStatus('error');
                    console.error('SSE error:', error);
                    
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        setTimeout(() => {
                            this.reconnectAttempts++;
                            this.setupEventSource();
                        }, 5000 * this.reconnectAttempts); // Exponential backoff
                    }
                };
            }
            
            updateConnectionStatus(status) {
                const badge = document.getElementById('connectionBadge');
                
                switch (status) {
                    case 'connected':
                        badge.className = 'badge bg-success';
                        badge.innerHTML = '<i class="fas fa-circle me-1"></i>Conectado';
                        break;
                    case 'error':
                        badge.className = 'badge bg-danger';
                        badge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Desconectado';
                        break;
                    default:
                        badge.className = 'badge bg-secondary';
                        badge.innerHTML = '<i class="fas fa-circle me-1"></i>Conectando...';
                }
            }
            
            async loadNotifications() {
                try {
                    const unreadOnly = document.getElementById('unreadOnlyFilter').checked;
                    const response = await fetch(`/api/notifications_api.php?action=list&unread_only=${unreadOnly}&limit=50`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.notifications = data.notifications || [];
                        this.renderNotifications();
                        this.updateUnreadCount();
                    } else {
                        console.error('Failed to load notifications:', data.msg);
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }
            
            async loadStats() {
                try {
                    const response = await fetch('/api/notifications_api.php?action=stats&hours=24');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderStats(data.stats);
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }
            
            renderStats(stats) {
                const container = document.getElementById('notificationStats');
                
                // Calculate totals
                const totals = stats.reduce((acc, stat) => {
                    acc.total += parseInt(stat.total) || 0;
                    acc.sent += parseInt(stat.sent) || 0;
                    acc.read += parseInt(stat.read) || 0;
                    acc.failed += parseInt(stat.failed) || 0;
                    acc.unread += parseInt(stat.unread) || 0;
                    return acc;
                }, { total: 0, sent: 0, read: 0, failed: 0, unread: 0 });
                
                container.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-bell text-primary fa-2x mb-2"></i>
                        <h4>${totals.total}</h4>
                        <small class="text-muted">Total (24h)</small>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-paper-plane text-success fa-2x mb-2"></i>
                        <h4>${totals.sent}</h4>
                        <small class="text-muted">Enviadas</small>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-eye text-info fa-2x mb-2"></i>
                        <h4>${totals.read}</h4>
                        <small class="text-muted">Lidas</small>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-envelope text-warning fa-2x mb-2"></i>
                        <h4>${totals.unread}</h4>
                        <small class="text-muted">Não Lidas</small>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-circle text-danger fa-2x mb-2"></i>
                        <h4>${totals.failed}</h4>
                        <small class="text-muted">Falharam</small>
                    </div>
                `;
            }
            
            renderNotifications() {
                const container = document.getElementById('notificationsList');
                
                if (this.notifications.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bell-slash text-muted fa-3x mb-3"></i>
                            <h5 class="text-muted">Nenhuma notificação encontrada</h5>
                            <p class="text-muted">Você está em dia com suas notificações!</p>
                        </div>
                    `;
                    return;
                }
                
                const notificationsHTML = this.notifications.map(notification => {
                    const isUnread = !notification.read_at;
                    const timeAgo = this.formatTimeAgo(notification.created_at);
                    const icon = this.getNotificationIcon(notification.type);
                    
                    return `
                        <div class="notification-item p-3 border rounded ${isUnread ? 'unread' : ''} priority-${notification.priority} type-${notification.type}" 
                             data-id="${notification.id}" onclick="markNotificationRead(${notification.id})">
                            <div class="d-flex">
                                <div class="notification-icon">
                                    <i class="${icon}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">${this.escapeHtml(notification.title)}</h6>
                                        <small class="text-muted">${timeAgo}</small>
                                    </div>
                                    <p class="mb-2">${this.escapeHtml(notification.message)}</p>
                                    ${notification.data ? this.renderNotificationData(notification.data) : ''}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-secondary">${notification.type}</span>
                                        <span class="badge bg-${this.getPriorityColor(notification.priority)}">${notification.priority}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = notificationsHTML;
            }
            
            renderNotificationData(data) {
                if (!data || Object.keys(data).length === 0) return '';
                
                const entries = Object.entries(data)
                    .filter(([key, value]) => key !== 'test' && value !== null)
                    .map(([key, value]) => `<strong>${key}:</strong> ${this.escapeHtml(String(value))}`)
                    .join(', ');
                
                return entries ? `<small class="text-muted">${entries}</small>` : '';
            }
            
            getNotificationIcon(type) {
                const icons = {
                    'location_update': 'fas fa-map-marker-alt',
                    'route_alert': 'fas fa-route',
                    'security_alert': 'fas fa-shield-alt',
                    'emergency': 'fas fa-exclamation-triangle',
                    'system_message': 'fas fa-cog',
                    'child_pickup': 'fas fa-child',
                    'arrival_notification': 'fas fa-flag-checkered',
                    'status_update': 'fas fa-info-circle'
                };
                return icons[type] || 'fas fa-bell';
            }
            
            getPriorityColor(priority) {
                const colors = {
                    'low': 'success',
                    'medium': 'warning',
                    'high': 'danger',
                    'critical': 'dark'
                };
                return colors[priority] || 'secondary';
            }
            
            formatTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Agora mesmo';
                if (minutes < 60) return `${minutes}min atrás`;
                if (hours < 24) return `${hours}h atrás`;
                return `${days}d atrás`;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            handleNewNotification(notification) {
                // Add to notifications array
                this.notifications.unshift(notification);
                
                // Keep only last 100 notifications
                if (this.notifications.length > 100) {
                    this.notifications = this.notifications.slice(0, 100);
                }
                
                // Update display
                this.renderNotifications();
                this.updateUnreadCount();
                
                // Show toast notification
                this.showToast(notification);
                
                // Play notification sound (optional)
                this.playNotificationSound();
            }
            
            handleSystemNotification(notification) {
                // System notifications are shown as toasts only
                this.showToast(notification, 'system');
            }
            
            showToast(notification, type = 'notification') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast_' + Date.now();
                
                const toastHTML = `
                    <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                        <div class="toast-header">
                            <i class="${this.getNotificationIcon(notification.type)} text-primary me-2"></i>
                            <strong class="me-auto">${this.escapeHtml(notification.title)}</strong>
                            <small class="text-muted">Agora</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${this.escapeHtml(notification.message)}
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
                
                // Remove from DOM after hiding
                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }
            
            playNotificationSound() {
                // Create audio element for notification sound
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmtSQjQtZoRDAY5DFQhEIjSTBAhEwEYh');
                audio.volume = 0.3;
                audio.play().catch(() => {
                    // Ignore audio play errors (user interaction required)
                });
            }
            
            updateUnreadCount() {
                const unreadCount = this.notifications.filter(n => !n.read_at).length;
                this.unreadCount = unreadCount;
                
                const badge = document.getElementById('unreadCount');
                badge.textContent = unreadCount;
                badge.className = unreadCount > 0 ? 'badge bg-danger ms-2' : 'badge bg-secondary ms-2';
                
                // Update page title
                document.title = unreadCount > 0 ? `(${unreadCount}) VanTracing - Notificações` : 'VanTracing - Notificações';
            }
            
            setupEventListeners() {
                document.getElementById('unreadOnlyFilter').addEventListener('change', () => {
                    this.loadNotifications();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'r': // Ctrl+R: Refresh
                                e.preventDefault();
                                this.loadNotifications();
                                break;
                            case 'a': // Ctrl+A: Mark all read
                                e.preventDefault();
                                markAllRead();
                                break;
                        }
                    }
                });
            }
        }
        
        // Global functions
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch('/api/notifications_api.php?action=mark_read', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notification_ids: [notificationId] })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update UI
                    const element = document.querySelector(`[data-id="${notificationId}"]`);
                    if (element) {
                        element.classList.remove('unread');
                    }
                    
                    // Update notification in array
                    const notification = notificationCenter.notifications.find(n => n.id == notificationId);
                    if (notification) {
                        notification.read_at = new Date().toISOString();
                    }
                    
                    notificationCenter.updateUnreadCount();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        async function markAllRead() {
            try {
                const response = await fetch('/api/notifications_api.php?action=mark_all_read', {
                    method: 'PUT'
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update UI
                    document.querySelectorAll('.notification-item.unread').forEach(element => {
                        element.classList.remove('unread');
                    });
                    
                    // Update notifications array
                    notificationCenter.notifications.forEach(notification => {
                        notification.read_at = new Date().toISOString();
                    });
                    
                    notificationCenter.updateUnreadCount();
                    
                    // Show success message
                    showAlert('Todas as notificações foram marcadas como lidas.', 'success');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showAlert('Erro ao marcar notificações como lidas.', 'danger');
            }
        }
        
        async function sendTestNotification() {
            try {
                const response = await fetch('/api/notifications_api.php?action=test', {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Notificação de teste enviada com sucesso!', 'success');
                } else {
                    showAlert('Erro ao enviar notificação de teste.', 'danger');
                }
            } catch (error) {
                console.error('Error sending test notification:', error);
                showAlert('Erro ao enviar notificação de teste.', 'danger');
            }
        }
        
        function refreshNotifications() {
            notificationCenter.loadNotifications();
            notificationCenter.loadStats();
            showAlert('Notificações atualizadas.', 'info');
        }
        
        function showAlert(message, type = 'info') {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertAdjacentHTML('afterbegin', alertHTML);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 3000);
        }
        
        // Initialize notification center
        let notificationCenter;
        document.addEventListener('DOMContentLoaded', () => {
            notificationCenter = new VanTracingNotificationCenter();
        });
    </script>
</body>
</html>